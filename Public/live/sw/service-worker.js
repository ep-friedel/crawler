'use strict';let jwt,stackTimer,flushInProgress,pastBody='',version='v5',offline=new Response(new Blob(),{status:279}),staticContent=['images/bookcase_48.png','images/bookcase_96.png','images/bookcase_192.png','images/bookcase_144.png','images/key.svg','images/library_back.png','images/library_book.png','images/book_16.ico','fonts/FontAwesome.otf?v=4.7.0','fonts/fontawesome-webfont.eot?v=4.7.0','fonts/fontawesome-webfont.svg?v=4.7.0','fonts/fontawesome-webfont.ttf?v=4.7.0','fonts/fontawesome-webfont.woff?v=4.7.0','fonts/fontawesome-webfont.woff2?v=4.7.0','js/admin.js','js/base.js','css/font-awesome.min.css','css/admin.css','css/base.css','index','admin'],onlineFirst=['api/getNewChapterList','api/requestFullChapterList','api/subscribeSeries'],offlineFirst=['api/requestChapter'],requestStack=[];const relativeUrl='index',serverUrl='https://crawler.fochlac.com/',apiUrl='https://crawler.fochlac.com/',iconUrl='/images/bookcase_144.png',offlineRegex=new RegExp(offlineFirst.map((a)=>a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,'\\$&')).join('|')),onlineRegex=new RegExp(onlineFirst.map((a)=>a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,'\\$&')).join('|')),staticRegex=new RegExp(staticContent.map((a)=>a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,'\\$&')).join('|'));function handle_push(a){if(clients.matchAll().then((a)=>{a.forEach(triggerRefresh)}),a.waitUntil(new Promise((b,c)=>{self.registration.getNotifications().then(closeOldMessages).then(()=>displayMessage(a.data.text())).then(b).catch(c)})),void 0!=jwt){let b,c,d=JSON.parse(a.data.text()),e=d.chapterArray,f=[];caches.open(version).then(function(a){e.forEach((a)=>{a.chapters.forEach((d)=>{b=apiUrl+'api/requestChapter?short='+a.short+'&chapter='+d+'&addToNew=false',c=new Request(b,{headers:new Headers({jwt:jwt})}),f.push(c)})}),Promise.all(f.map((b)=>a.delete(b))).then(()=>a.addAll(f)).catch((a)=>console.warn(a))}).catch((a)=>console.warn(a))}}function handle_click(a){self.registration.getNotifications().then((a)=>a.forEach((a)=>a.close())),pastBody='',a.waitUntil(clients.matchAll().then(function(a){let b=a.some((a)=>{if(a.url===serverUrl+relativeUrl&&'focus'in a)return a.focus()});if(!b&&clients.openWindow)return clients.openWindow(relativeUrl)}).catch((a)=>console.warn(a)))}function handle_message(a){let b=a.data;switch(b.type){case'resetBase':pastBody='';break;case'newJWT':jwt=b.jwt;break;case'deleteJWT':jwt=void 0,clearCache();break;case'clearCache':clearCache();}}function handle_fetch(a){if(!('GET'===a.request.method))navigator.onLine||(a.respondWith(offline.clone()),requestStack.push(a.request),stackTimer=setInterval(flushStack,3e4));else if(onlineRegex.test(a.request.url)){let b=a.request.clone();a.respondWith(fetch(a.request).then((a)=>{return caches.open(version).then((c)=>{c.put(b.clone(),a.clone())}),a.clone()}).catch(()=>{return caches.open(version).then((a)=>{return a.match(b)}).then((a)=>{return a?a:offline.clone()}).catch((a)=>console.warn(a))}))}else offlineRegex.test(a.request.url)?a.respondWith(caches.open(version).then((b)=>{return b.match(a.request).then((b)=>{if(b)return b;let c=a.request;return fetch(c.clone()).then((a)=>{caches.open(version).then((b)=>{b.put(c.clone(),a.clone())}).catch((a)=>console.warn(a))}).catch((a)=>console.warn(a)),fetch(c.clone()).catch((a)=>console.warn(a))}).catch((a)=>console.warn(a))}).catch((a)=>console.warn(a))):staticRegex.test(a.request.url)&&a.respondWith(caches.open(version).then((b)=>{return b.match(a.request.clone())}).then((b)=>{return b?b:(cacheStatic(),fetch(a.request).catch((a)=>console.warn(a)))}).catch((a)=>console.warn(a)))}function clearCache(){caches.keys().then((a)=>a.filter((a)=>a!==version)).then((a)=>Promise.all(a.map((a)=>caches.delete(a)))).then(()=>caches.open(version)).then((a)=>{a.keys().then((b)=>b.filter((a)=>!staticRegex.test(a.url)).map((b)=>a.delete(b)))}).catch((a)=>console.warn('deleteAllCaches ',a))}function flushStack(){navigator.onLine&&!flushInProgress&&0<requestStack.length&&(flushInProgress=!0,new Promise(fetchFirstRequestFromStack).then(()=>{clearInterval(stackTimer)}).catch((a)=>console.warn(a)))}function fetchFirstRequestFromStack(a,b){fetch(requestStack[0]).then((c)=>{(200===c.status||500===c.status)&&(requestStack.splice(0,1),0<requestStack.length?fetchFirstRequestFromStack(a,b):a())}).catch(b)}function cacheStatic(){return caches.open(version).then(function(a){return a.addAll(staticContent.map((a)=>serverUrl+a))}).catch((a)=>console.warn(a))}function closeOldMessages(a){return new Promise((b)=>{a&&a.length&&a.forEach((a)=>a.close()),b()})}function displayMessage(a){let b=JSON.parse(a),c=b.chapterArray,d=pastBody;return c.forEach((a)=>{d+=a.short+': '+a.chapters.join(', ')+'. '}),b.silent&&b.vibrate&&(navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate,navigator.vibrate&&navigator.vibrate([1000])),pastBody=d,self.registration.showNotification('New Chapters for:',{body:d,icon:iconUrl,silent:'1'==b.silent})}function triggerRefresh(a){a.url===serverUrl+relativeUrl&&a.postMessage('newChapter')}self.addEventListener('notificationclick',handle_click),self.addEventListener('message',handle_message),self.addEventListener('fetch',handle_fetch),self.addEventListener('push',handle_push),self.addEventListener('install',(a)=>{a.waitUntil(cacheStatic()),self.skipWaiting()});